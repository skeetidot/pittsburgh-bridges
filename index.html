<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>The Evolution of Pittsburgh's River Bridges</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <!-- Load Normalize CSS -->
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.1.1/normalize.min.css">

    <!-- Load Mapbox library -->
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>

    <!-- Load Leaflet Omnivore plugin -->
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>

    <!-- Load jQuery library -->
    <script src='https://code.jquery.com/jquery-1.12.0.min.js'></script>
    
    <!-- Load jQuery UI library with autocomplete function -->
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>  
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.min.css">    

    <!-- Load Simple Statistics library -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/1.0.1/simple_statistics.min.js'></script>

    <!-- Load Mapbox CSS -->
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />

    <!-- Load Google Fonts -->    
    <link href='https://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet' type='text/css'>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: whitesmoke;
            font-family: "Open Sans", sans-serif;
            color: #3d3d3d;
            overflow-x: hidden;
            overflow-y: hidden;
        }
        
        h1 {
            padding: 8px 25px 8px 15px;
            color: #ffd401; /* Pittsburgh gold */
            margin: 0;
            background: #3d3d3d; 
            font-weight: 400;
            font-size: 1.3em;
            text-align: left;
            font-family: "Merriweather", serif;
            border-bottom: 2px solid #3d3d3d; 
        }
        
        h2 {
            margin: 0;
            padding: 8px 25px 0px 15px;
            color: #3d3d3d;
            font-weight: 500;
            font-size: 1.1em;
            text-align: left;
            font-family: "Merriweather", serif;
        }
        
        a {
            color: #3d3d3d;
        }
        
        #map {
            position: absolute;
            top: 40px;
            bottom: 0;
            right: 0;
            width: 67%;
        }
        
        .leaflet-container .leaflet-control-attribution {
            background-color: rgba(235,235,235,.75);
        }
        
        
    /* Tooltip */
        
        #tooltip {
            padding: 4px 4px;
            background: white;
            border: solid 1px #999999;
            border-radius: 3px;
            color: #3d3d3d;
            position: absolute;
            font-size: 0.8em;
            max-width: 325px;
            display: none; /* don't display until the user mouses over a bridge */
            text-align: left;
        }
        
        #tooltip p {
            margin: 3px 0 4px;
            text-align: left;
        }
        
        #tooltip span:first-child {
            font-size: 1em;
            font-weight: bold;
            text-align: left;
        } 
        

    /* Side Panel */
        
        #side-panel {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 33%;
            background: #ffea80; /* light Pittsburgh gold */
            border-right: 2px solid #3d3d3d;
        }
        
        #side-panel p {
            margin: 8px 0 4px;
            padding: 0 25px 0 15px;
            text-align: left;
            font-size: 0.825em;
        }
        
        #side-panel p:after {
            content: '';
            display: block;
            clear: both;
        }
        
    
    /* Details Panel */
        
        #detailsPanel {
            position: absolute;
            margin: 20px 0 0 0;    
            display: none;  /* don't display until the user clicks a bridge */
            height: 70%;
        }
        
        #detailsPanelContent {
            overflow-y: auto; 
            margin-top: -5px;
            margin-bottom: -5px;
        }
        
        .section{
            display:inline-block;
            width:100%;
            background: #3d3d3d;
        }
        
        #detailsPanel h1 {
            float: left;
            display: inline;
            margin-right: 30px;
            z-index: 99;
            font-size: 1.1em;
        }
        
        #closeButton {
            cursor: pointer;
            width: 16px;
            height: 16px;
            left: 31%;
            display: inline;
            padding-top: 11px;
            position: fixed;
        }
            
        #detailsPanel p {
            text-align: left;
            margin: 8px 0px 15px; 
        }
        
        #detailsPanel p .imageSource {
            margin-left: 6.5%;
            font-size: 0.77em;
        }
        
        #detailsPanel p .description {
            margin-top: -10px;
            line-height: 1.5;
        }
        
        #detailsPanel #photo {
            width: 82%;
            margin: 15px auto;
            margin-bottom: -5px;
            padding: 0;
            display: block;
            border-radius: 3px;
            border: solid 1px #3d3d3d;
            color: #3d3d3d;
        }
        

    /* Marker List */
        
        #markerListPanel {
            position: absolute; 
            width: 100%;
            margin: 20px 0 0 0;
            height: 70%;
        }
        
        #markerListPanelContent {
            left: -50px;
            overflow-y: auto;
            margin-right: 0px;
        }        

        #marker-list {
            font-size: 0.825em;
            margin-top: 5px; 
            margin-bottom: 5px;
        }
  
        #marker-list li {
            padding: 5px;
            margin-left: -30px;
            list-style-type: none;
        }
        
        #marker-list li:hover {
            cursor: pointer;
            background: #3d3d3d;
            color: #ffd401;
        }
        
        #markerListPanel h1 {
            max-height: 100px;
            margin-right: -1px;
            z-index: 99;
            font-size: 1.1em; 
        }   
        
        
    /* Year Slider */
        
        #ui-controls {
            position: absolute;
            width: 176px;
            padding: 6px 15px 4px 15px;
            background: white;
            border-radius: 3px;
            color: #3d3d3d;
            left: 36px;
            border: solid 1px #999999;
        }
        
        .year-slider {
            width: 100%;
        }     
        
        #ui-controls .min {
            float: left;
        }
        
        #ui-controls .max {
            float: right;
        }
        
        #currentYearTitle {
            margin: 0;
            position: absolute;
            left: 33%;
            top: 0;
            width: 100%;
            background: #ffea80; /* Pittsburgh gold */
            color: #3d3d3d;
            border-left: 2px solid #3d3d3d;
            font-weight: 600;
            text-align: left;
            font-family: "Merriweather", serif;   
        }
        
        #currentYearTitle h1 {
            background: #ffea80; /* light Pittsburgh gold */
            color: #3d3d3d;
        }
        
        label {
            font-weight: 400;
            font-family: Merriweather, serif;
            width: 200px;
        }
        

    /* Search */

        .search-ui {
            position: absolute;
            top: 7px;
            right: 15px;
            z-index: 1000;
            font-family: "Open Sans", sans-serif;
        }
        #search {
            padding-left: 10px;
        }
        .ui-widget {
            font-family: "Open Sans", sans-serif;
            font-size: 0.8em;
            color: #3d3d3d;
            overflow-y: auto;
            overflow-x: hidden;
            max-width: 250px;
            max-height: 300px;
        }
        
        .ui-autocomplete-input {
            width: 250px;
            font-size: 0.9em;
        }
        
        
    /* Legend */
        
        #bridgeTypeLegend {   
            position: absolute;
            right: 15px;
            bottom: 20px;
            padding: 4px 12px 0px 15px;
            background: white;
            border: solid 1px #999999;
            border-radius: 3px;
            color: #3d3d3d;
            text-align: left;
            font-family: "Merriweather", sans-serif;
        }
        
        #bridgeTypeLegend h3 {
            text-align: left;
            font-weight: 500;
            margin: 10px 0 4px;
            font-size: 1em;
        }
        
        #bridgeTypeLegend h3.status {
            text-align: left;
            font-weight: 500;
            margin: -4px 0 4px;
            font-size: 1em;
        }

        #bridgeTypeLegend span {
            position: absolute;
            border-radius: 50%;
            border: 1px solid black;
            width: 10px;
            height: 10px;
            margin-top: 6px;
            margin-right: 4px; 
        }

        .highlightCircle {
            border-radius: 50%;
            border: 1px solid black;
            width: 15px;
            height: 15px;
            margin-top: 6px;
            margin-right: 4px;
        }  
        
        #bridgeTypeLegend label {
            text-align: left;
            font-weight: 400;
            margin-left: 25px;
            font-family: "Open Sans", sans-serif;
            font-size: 0.8em;
        }
        
        #bridgeTypeLegend label:after {
            content: '';
            display: block;
            clear: both;
        }
        
        #bridgeTypeLegend note {
            text-align: left;
            font-weight: 400;
            margin-top: 25px;
            margin-left: 25px;
            font-family: "Open Sans", sans-serif;
            font-size: 0.8em;
        }
        
        #bridgeTypeLegend note:after {
            content: '';
            display: block;
            clear: both;
        } 

    </style>
</head>

<body>

    <!-- Create the map div -->
    <div id='map'></div>

    <!-- Create the side panel div -->
    <div id='side-panel'>
        <div id="intro">
            <h1>The Evolution of Pittsburgh's River Bridges</h1>

            <p>This map is an interactive companion to the book, <a href="http://www.amazon.com/Pittsburghs-Bridges-Images-America-Wilson/dp/1467134244" target="_blank"><i>Pittsburgh's Bridges (Images of America)</i></a>, by Todd Wilson, PE, and Helen Wilson, showcasing how the river bridges in Pittsburgh, Pennsylvania evolved from the wooden covered bridges of yesterday to those that define the skyline today.</p>

            <p>Scroll the slider through Pittsburgh's 200-year history to see when and where bridges first appeared and why the city became known as the "City of Bridges".</p>
            
            <p>To see a specific bridge from any year, click its name from the list below or type its name into the search box.</p>

            <p>Bridge data and photos were acquired from <a href="http://www.amazon.com/Pittsburghs-Bridges-Images-America-Wilson/dp/1467134244" target="_blank"><i>Pittsburgh's Bridges (Images of America)</i></a>, <a href="http://www.pghbridges.com" target="_blank">Bruce Cridlebaugh</a>, or Todd Wilson.</p>
            
            <p>Map developed by <a href="http://skeetidot.github.io" target="_blank">Lauren Winkler</a>.</p>
        </div>

        <!-- Create the marker list div, which will display all bridges from all years -->
        <div id = "markerListPanel">
            <div class="section">
                <h1>All Bridges</h1>
            </div>
            <div id="markerListPanelContent">
                <ul id='marker-list'></ul>
            </div>
        </div>
        
        <!-- Create the details panel div, which will display the bridge name, year built and demolished, image, image source, and description -->
        <div id="detailsPanel">
            <div class="section">
                <img id="closeButton" src="icons/close.png" alt_text="Close details panel" title="Close">
                <h1>Name (Built - Demolished)</h1>   
            </div>
            <div id="detailsPanelContent">
                <img id="photo" src="">
                <p><span class="imageSource">Image Source</span></p>
                <p><span class="description">Description</span></p>
            </div>
        </div>  
    </div>
    
    <!-- Create the current year heading with initial year of 2016 -->
    <div id="currentYearTitle">
        <h1>Pittsburgh's River Bridges in <span>2016</span></h1>
    </div>
    
    <!-- Create the range slider control -->
    <div id="ui-controls">
        <label>
            <span class="min">1816</span>
            <span class="max">2016</span>
            <input type="range" min="1816" max="2016" value="2016" step="1" class="year-slider" title="Click and drag the slider to see the bridges that existed in the selected year">
        </label>
    </div>

    <!-- Create the search box -->
    <div class="search-ui" width="500px">
        <input id="search" value="Search by bridge name">
    </div>
    
    <!-- Create the div to store the legend for the bridge types -->
    <div id="bridgeTypeLegend">
        <h3>Bridge Type</h3>
    </div>

    <!-- Create the tooltip div, which will display the bridge name and its year built and demolished when the user hovers over a bridge -->
    <div id="tooltip">
        <p><span></span> <br><span></span></p>
    </div>

    <script>
 
        
        // Default basemap tiles
        var Esri_WorldGrayCanvas = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
            maxZoom: 16,
        });
        
        var Esri_WorldGrayReference = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
            minZoom: 13,
            maxZoom: 16
        });
        
        // Set Mapbox access token
        L.mapbox.accessToken = 'pk.eyJ1Ijoic2tlZXRpZG90IiwiYSI6IjJHd3UxZDgifQ.aeE1dODYNEMRwHQZT1MrLA';

        // Set the map options
        var options = {
            center: [40.43, -79.97], // centered in Pittsburgh
            zoom: 12, // initial zoom
            minZoom: 12,
            maxZoom: 16,
            maxBounds: L.latLngBounds([40.28,-80.12], [40.58,-79.82]), // panning bounds so the user doesn't pan too far away from Pittsburgh
        }

        // Create a new Leaflet map, passing map options, and assign it to the map variable
        var map = L.mapbox.map('map', 'mapbox.light', options);
        
        
        // self-invoking function to place slider on map using
        // Leaflet DomUtil
        (function() {

            // create a Leaflet control object and store a reference to it in a variable
            var sliderControl = L.control({ position: 'topleft'} );

            // when we add this control object to the map
            sliderControl.onAdd = function(map) {

                // select an existing DOM element with an id of "ui-controls"
                var slider = L.DomUtil.get("ui-controls");

                    // when the user clicks on the slider element
                    L.DomEvent.addListener(slider, 'mousedown', function(e) { 

                        // prevent the click event from bubbling up to the map
                        L.DomEvent.stopPropagation(e); 

                    });

                // return the slider from the onAdd method
                return slider;
            }

            // add the control object containing our slider element to the map
            sliderControl.addTo(map);

        })();


        // Add the basemap
        map.addLayer(Esri_WorldGrayCanvas);
        map.addLayer(Esri_WorldGrayReference);
        
        // Initialize the marker list
        var markerList = document.getElementById('marker-list');
        
        // Define global variables
        var bridges,
            bridgesFeatureLayer,
            bridgeName = "Bridge",
            bridgeType = "Type",
            yearBuilt = "Year_Built",
            yearDemolished = "Year_Demolished",
            photoPath = "Photo_Path",
            imageSource = "Image_Source",
            description = "Notes";
            currentYear = 2016;
            bridgeArray = [];
            selectedBridge = '';
        
        // Use the Omnivore plugin to load the bridge points asynchronously and add them to the map if they have been properly loaded
        var bridges = omnivore.csv('data/pittsburgh_bridges.csv', null, L.mapbox.featureLayer())
        
            // If the data has been properly loaded, convert it to a traditional GeoJSON layer and call the drawMap() function
            .on('ready', function(e) {
                drawMap(e.target.toGeoJSON());
            })
            
            // If the data cannot be loaded or parsed, log an error message to the console
            .on('error', function(e) {
                console.log(e.error[0].message);
            })

        //Use JQuery's getJSON() method to load the city boundary data asynchronously
        $.getJSON("data/city_border.geojson", function (data) {

            // Create a Leaflet GeoJson layer for the city boundary and add it to the map
            cityBorder = L.geoJson(data, {

                // Create a style for the city boundary
                style: function (feature) {
                    return {
                        color: '#3d3d3d', // set stroke color
                        weight: 2, // set stroke weight
                        fillOpacity: 0, // override default fill opacity
                        opacity: 1   
                    };
                }
            }).addTo(map);
            
            // Move the city boundary to the bottom of the layer order
            cityBorder.bringToBack();
        });
        
        // Draw the bridges for the initial year (2016) and call the updateYear() function to update the bridges as the user moves the year slider
        function drawMap(bridges) {
       
            // Create a Mapbox feature layer for the bridges and add it to the map
            bridges = L.mapbox.featureLayer(bridges, {
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        fillColor: 'white', // default fill color, won't be displayed
                        fillOpacity: 1,
                        color: 'black',
                        weight: 1.25,
                        opacity: 1,
                        radius: 6
                    });
                }
            }).addTo(map);
            
            // Build the bridge list for the search dropdown
            buildBridgeList(bridges);
            
            // Call the search() function to autocomplete the list of bridges as the user types
            search(bridges, bridgeArray, currentYear);
            
            // Call the updateMap() function to draw the bridges which existed in the current year (2016)
            updateMap(bridges, currentYear);

            // Call the updateYear() function to update the map as the user moves the year slider
            updateYear(bridges, currentYear);
            
            // Call the drawLegend() function to draw the legend
            drawLegend();
            
            // Create and display the tooltip when the user hovers over a bridge
            createTooltip(bridges);
                
            // When the user clicks one of the bridges
            bridges.on('click', function (e) {
                // Create and display the details panel when the user clicks a bridge
                createDetailsPanel(bridges, e);
            });
            
            // Create and display the marker list
            createMarkerList(bridges, currentYear);
        }
        
        // Populate the bridge list array with the bridge names in the GeoJson layer
        function buildBridgeList(bridges) {
            
            // Loop through each feature in the bridges GeoJson layer
            bridges.eachLayer(function (layer) {

                // Create a shorthand variable to access the layer properties
                var props = layer.feature.properties;
                bridgeName = props.Bridge;
                
                // Push the current bridge name into the bridge array
                bridgeArray.push(props.Bridge);
                
            });
            
            // Return the bridge array so it can be used in the search dropdown
            return bridgeArray;
        }

        // Symbolize the bridges based on their type
        function getColor(bridgeType) {
            
            if (bridgeType == "Through Truss" || bridgeType == "Deck Truss") {
                return '#ff0000'; // red
                
            } else if (bridgeType == "Wooden Covered Truss") {
                return '#ad661f'; // brown     
            
            } else if (bridgeType == "Arch") {
                return '#ffd401'; // Pittsburgh gold
                
            } else if (bridgeType == "Suspension") {
                return '#0040ff'; // blue
                
            } else if (bridgeType == "Steel Girder" || bridgeType == "Lattice Girder") {
                return '#009933'; // green
                
            } else {
                return '#666666'; // gray
            }
        }
        
        // When the user updates the slider, determine the current year, update the map based on bridges existing in the current year, and update the current year in the heading
        function updateYear(bridges, currentYear) {
            
            // Select the current year label inside the currentYearTitle div element's span tag
            var output = $('#currentYearTitle h1 span');
            
            // Select the slider div element
            $('.year-slider')
            
            // When the user updates the slider
            .on('input change', function() {

                // Determine the current year
                currentYear = $(this).val();

                // Update the currentYearTitle div to display the current year
                output.html(currentYear);
                
                // Update the map to show the bridges in the current year
                updateMap(bridges, currentYear);
                
                // Hide the details panel
                $('#detailsPanel').hide();
                
                // Show the marker list
                $('#markerListPanel').show();  
            });
        }
        
        // Update the bridges based on the currently selected year
        function updateMap(bridges, currentYear) {

            // Loop through each feature in the bridges GeoJson layer
            bridges.eachLayer(function (layer) {

                // Create a shorthand variable to access the layer properties
                var props = layer.feature.properties;
                currentYear = Number(currentYear);
                yearBuilt = Number(props["Year_Built"]);
                yearDemolished = Number(props["Year_Demolished"]);
                bridgeName = props.Bridge;
                bridgeType = props.Type;
                
                // If the bridge was built after the current year or demolished before the current year, hide it
                if (yearBuilt > currentYear || (yearDemolished < currentYear && yearDemolished != "")) {    
                    layer.setStyle({
                        stroke: false,
                        fill: false
                    });
                }
                
                // Otherwise, the bridge existed during the current year, so display it and get its fill color, calling the getColor() method to determine the appropriate color based on its type
                else {
                    layer.setStyle({
                        stroke: true,
                        fill: true,
                        fillColor: getColor(bridgeType)
                    }); 

                    if (currentYear-yearBuilt<=5) {
                        layer.setStyle({
                            radius: 9,
                            weight: 4,
                            color: 'yellow'
                        });
                    } else {
                        layer.setStyle({
                            radius: 6,
                            weight: 1.25,
                            color: 'black'
                        });
                    }
                }    
            });
        }
        
        // Create and display the tooltip when the user hovers over a bridge
        function createTooltip(bridges) {
            
            // Select the tooltip div
            var tooltip = $('#tooltip');

            // When the user mouses over one of the bridges
            bridges.on('mouseover', function (e) {

                // Access the properties of the selected feature and assign it to the props variable
                var props = e.layer.feature.properties;

                // Set the year built and year demolished for the selected bridge
                yearBuilt = Number(props["Year_Built"]);
                yearDemolished = Number(props["Year_Demolished"]);

                // Select and display the tooltip div
                tooltip.show();

                // Populate the first span tag in the tooltip with the bridge name for selected feature
                $('#tooltip span:first-child').text(props.Bridge);

                // If there is no year demolished, display the year demolished as "present"
                if (yearDemolished == 0) {
                    yearDemolished = "present";
                }

                // Populate the last span tag in the tooltip with the year built and demolished for selected feature
                $('#tooltip span:last-child').text("(" + yearBuilt + "-" + yearDemolished + ")");
            });

            // When the user mouses off of the bridges
            bridges.on('mouseout', function (e) {

                // Access the properties of the selected feature and assign it to the props variable
                var props = e.layer.feature.properties;

                // Hide the tooltip
                tooltip.hide();
            });
            
            // When the user moves the mouse, position the tooltip next to the cursor
            $(document).mousemove(function (e) {

                // First offset the tooltip above and to the right of the current cursor position
                tooltip.css({
                    "left": e.pageX + 6, // X coordinate of the cursor + 6px
                    "top": e.pageY - tooltip.height() - 15 // Y coordinate of the cursor - the height of the tooltip - 15px
                });

                // If the tooltip crashes into the top of the page, flip it to appear below the current cursor position
                if (tooltip.offset().top < 50) {
                    tooltip.css({
                        "top": e.pageY + 15 // Y coordinate of the  cursor + 15px
                    });
                }

                // If the tooltip crashes into the right of the page, flip it to appear to the left the current cursor position
                if (tooltip.offset().left + tooltip.width() >= $(document).width() - 40) {
                    tooltip.css({
                        "left": e.pageX - tooltip.width() - 30 // X coordinate of the cursor - the width of the tooltip - 30px
                    });
                }
            });
        }
        
        // Create and display the details panel when the user clicks a bridge
        function createDetailsPanel(bridges, e) {

            // Get the current year
            currentYear = $('.year-slider').val(); 

            // Call the updateMap() function to remove the highlighting from the previously selected bridge and redraw the map for the current year
            updateMap(bridges, currentYear);
            
            // Increase the circle size for the selected bridge and add a highlight
            e.layer.setStyle({
                radius: 15,
                weight: 4,
                color: 'aqua'
            });

            // Bring the selected bridge to the front
            e.layer.bringToFront();

            // Access the properties of the selected feature and assign it to the props variable
            var props = e.layer.feature.properties

            // Get the year built and year demolished for the selected bridge
            yearBuilt = Number(props["Year_Built"]);
            yearDemolished = Number(props["Year_Demolished"]);

            // If there is no year demolished, display the year demolished as "present"
            if (yearDemolished == 0) {
                yearDemolished = "present";
            }

            // Populate the heading in the details panel with the bridge name for the selected feature
            $('#detailsPanel h1').text(props.Bridge + " (" + yearBuilt + "-" + yearDemolished + ")");

            // If there is a photo for the selected feature
            if (props.Photo_Path !== "None") {

                // Show the image and image source if it was previously hidden
                $('#photo').show();
                $('.imageSource').show(); 

                // Build the image source and alt text for the selected feature and populate it in the image of the details panel
                $('#photo').attr("src", props.Photo_Path);
                $('#photo').attr("alt_text", "Image of " + props.Bridge);

                // Populate the image source in the details panel
                $('.imageSource').text("Image Source: " + props.Image_Source);     
            }

            // Otherwise, there is no photo for the selected feature
            else {
                // Hide the image and image source
                $('#photo').hide();
                $('.imageSource').hide();    
            }

            // Populate the description in the details panel
            $('.description').text(props.Notes);
            
            // Hide the marker list
            $('#markerListPanel').hide();

            // Display the details panel
            $('#detailsPanel').show();
            
            // Set the height of the details panel content based on the window height, minus the height of the intro section, minus the height of the panel heading, minus padding values
            $('#detailsPanelContent').height($(window).height()-$('#intro').height()-$('#detailsPanel h1').height()-42); 
            
            // Recalculate the height of the details panel content if the window is resized
            window.onresize = function() {
                $('#detailsPanelContent').height($(window).height()-$('#intro').height()-$('#detailsPanel h1').height()-42);
            }

            // Select the close icon
            close = $('#closeButton');

            // When the user clicks the close icon
            close.on('click', function (e) {

                // Close the details panel
                $('#detailsPanel').hide();

                // Show the marker list
                $('#markerListPanel').show();

                // Call the updateMap() function to remove the highlighting from the selected bridge
                updateMap(bridges, currentYear);
            });
            
        } 
        
        // Create the legend    
        function drawLegend() {

            // Select the legend div element
            var legend = $('#bridgeTypeLegend');

            // Create an object called "circles" and store the legend text and call the getColor() method to access the color
            var bridgeTypes = {
                metalTruss: {
                    name: "Metal Truss",
                    color: getColor("Through Truss")
                },
                woodenCoveredTruss: {
                    name: "Wooden Covered Truss",
                    color: getColor("Wooden Covered Truss")
                },
                arch: {
                    name: "Arch",
                    color: getColor("Arch")
                },
                suspension: {
                    name: "Suspension",
                    color: getColor("Suspension")
                },
                girder: {
                    name: "Girder",
                    color: getColor("Steel Girder")
                }
            };

            // Create an empty string called "legendContent" to store the HTML that will draw the circles and their labels in the legend
            var legendContent = '';
            
            // Loop through the circles object to get the legend text and color for each bridge type
            for (var type in bridgeTypes) {
                
                // Build the legend row for the current bridge type
                legendContent += '<span class="circle" style="background:' + bridgeTypes[type].color + ';"></span> ' + '<label>' + bridgeTypes[type].name + '</label>';  

            }
            
            // Build the bridge status section of the legend content
            legendContent += '<h3 class="status">Bridge Status</h3>';
            legendContent += '<span class="highlightCircle" style="background: gray; border: 5px solid yellow; width: 15px; height: 15px; margin-left: -7px; margin-top: 0px"></span><note>Built within 5 years of selected year</note>';

            // Add the legendContent string as HTML to the legend div
            legend.append(legendContent);

        }

        // Search for bridges. Autocomplete the list as the user types. When the user selects a bridge, zoom to the selected bridge, highlight it, and open its details panel.
        function search(bridges, bridgeArray, currentYear) {
            
            var $search = $('#search');
            
            // Clear the default search text when user goes to search
            $search.focus(function(){
                $(this).val('');
            });
            
            // Restore the default search text when the user focuses off of the search box
            $search.focusout(function() {
                $(this).val('Search by bridge name');
            })
            
            // Create the autocomplete dropdown list with the bridge names in the bridgeArray
            $("#search").autocomplete({
              source: bridgeArray
            });
            
            // When the user chooses a value from the dropdown list
            $("#search").on("autocompleteselect", function(event, ui) {
                
                // Assign the current value in the search box as the selectedBridge
                selectedBridge = ui.item.value;
                
                // Loop through all the bridges
                bridges.eachLayer(function(layer) {
                    
                    // If the bridge name matches the one in the search box
                    if(layer.feature.properties.Bridge == selectedBridge) {
                        
                        // Create a shorthand variable to access the layer properties
                        props = layer.feature.properties;

                        // Call the getBridgeDetails() function to build the bridge details panel for the selected bridge
                        getBridgeDetails(bridges, currentYear, layer, props);
                    }
                });
                
                // Clear the value in the search box
                ui.item.value = '';
            
            });
        }
    
        function createMarkerList(bridges, currentYear) {
        
            // Set the height of the marker list panel content based on the window height, minus the height of the intro section, minus the height of the marker list panel heading, minus padding values
            $('#markerListPanelContent').height($(window).height()-$('#intro').height()-$('#markerListPanel h1').height()-42);
            
            // Recalculate the height of the marker list panel content if the window is resized
            window.onresize = function() {
                $('#markerListPanelContent').height($(window).height()-$('#intro').height()-$('#markerListPanel h1').height()-42);
            } 

            // Loop through all the bridges
            bridges.eachLayer(function(layer) {
                
                // Create a shorthand variable to access the layer properties
                var props = layer.toGeoJSON().properties;
                currentYear = Number(currentYear);
                yearBuilt = Number(props["Year_Built"]);
                yearDemolished = Number(props["Year_Demolished"]);
                bridgeName = props.Bridge;
                bridgeType = props.BridgeType;
                
                // If there is no year demolished, display the year demolished as "present"
                if (yearDemolished == 0) {
                    yearDemolished = "present";
                }
                
                // Build the marker list
                var item = markerList.appendChild(document.createElement('li'));
                item.innerHTML = bridgeName + " (" + yearBuilt + "-" + yearDemolished + ")";
                item.onclick = function(e) {
                    
                    // Call the getBridgeDetails() function to build the bridge details panel for the selected bridge
                    getBridgeDetails(bridges, currentYear, layer, props);
                    
                };
            });

        }
        
        // Build the bridge details panel for the selected bridge, if accessed from the bridge list or search dropdown
        function getBridgeDetails(bridges, currentYear, layer, props) {
            
            // Hide the previous details panel
            $('#detailsPanel').hide(); 
                 
            // Zoom to the selected bridge at zoom level 13
            map.setView(layer.getLatLng(), 13);

            // Set the current year as the year the selected bridge was built
            currentYear = layer.feature.properties["Year_Built"];

            // Select the current year label inside the currentYearTitle div element's span tag
            var output = $('#currentYearTitle h1 span');

            // Update the value of the year slider to the current year
            $('.year-slider').val(currentYear);

            // Update the currentYearTitle div to display the current year
            output.html(currentYear);

            // Update the map to show the bridges in the current year
            updateMap(bridges, currentYear);

            // Increase the circle size for the selected bridge and add a highlight
            layer.setStyle({
                radius: 15,
                weight: 4,
                color: 'aqua'
            });

            // Bring the selected bridge to the front
            layer.bringToFront();

            // Access the properties of the selected feature and assign it to the props variable
            var props = layer.feature.properties;

            // Get the year built and year demolished for the selected bridge
            yearBuilt = Number(props["Year_Built"]);
            yearDemolished = Number(props["Year_Demolished"]);

            // If there is no year demolished, display the year demolished as "present"
            if (yearDemolished == 0) {
                yearDemolished = "present";
            }

            // Populate the heading in the details panel with the bridge name for the selected feature
            $('#detailsPanel h1').text(props.Bridge + " (" + yearBuilt + "-" + yearDemolished + ")");

            // If there is a photo for the selected feature
            if (props.Photo_Path !== "None") {

                // Show the image and image source if it was previously hidden
                $('#photo').show();
                $('.imageSource').show(); 

                // Build the image source and alt text for the selected feature and populate it in the image of the details panel
                $('#photo').attr("src", props.Photo_Path);
                $('#photo').attr("alt_text", "Image of " + props.Bridge);

                // Populate the image source in the details panel
                $('.imageSource').text("Image Source: " + props.Image_Source);     
            }

            // Otherwise, there is no photo for the selected feature
            else {
                // Hide the image and image source
                $('#photo').hide();
                $('.imageSource').hide();    
            }

            // Populate the description in the details panel
            $('.description').text(props.Notes);
            
            // Hide the marker list
            $('#markerListPanel').hide();

            // Display the details panel
            $('#detailsPanel').show(); 
            
            // Set the height of the details panel content based on the window height, minus the height of the intro section, minus the height of the panel heading, minus padding values
            $('#detailsPanelContent').height($(window).height()-$('#intro').height()-$('#detailsPanel h1').height()-42);

            // Recalculate the height of the details panel content if the window is resized
            window.onresize = function() {
                $('#detailsPanelContent').height($(window).height()-$('#intro').height()-$('#detailsPanel h1').height()-42);
            }

            // Select the close icon
            close = $('#closeButton');

            // When the user clicks the close icon
            close.on('click', function (e) {

                // Close the details panel
                $('#detailsPanel').hide();

                // Show the marker list
                $('#markerListPanel').show();

                // Call the updateMap() function to remove the highlighting from the selected bridge
                updateMap(bridges, currentYear);
            });
            
        }
        
                
        // Add Google Analytics
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-79363392-1', 'auto');
          ga('send', 'pageview');   
 
    </script>
</body>

</html>